<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> 
<head>
<meta charset="utf-8"/>
<script type="text/javascript">
  //global value
  var url_origin = "http://www.jorudan.co.jp/norikae/cgi/nori.cgi?";
  var buffer_Minutes=0;
  var search_other_query = "C7=1&C2=0&C3=0&C1=0&C4=0&C6=2&S.x=41&S.y=13&S=検索&Cmap1=0&rf=nr&pg=0&Csg=1";


chrome.omnibox.onInputEntered.addListener(function(text){
  init();
  var url=getURL(text);
  navigate(url);
});

function getURL(text){
  var query = text.replace(/^\s+|\s+$/g,"").split(/[\s,]+/);
  var station_from = "eki1="+query[0]+ "&";
  var station_to = "eki2="+query[1]+"&";
  var search_kind = setSearchKind(query[2],query[3]);
  var url = "";
  if(isStationSet(query[0],query[1]) == 1 && search_kind != -1){
    url = getSearchURL(query[0],query[1],query[2],query[3],search_kind);
  } else {
    alert("入力が間違えています。");
  }
  return url;
}

function isStationSet(arg1,arg2){
  var flag=-1;
  if(arg1!=undefined && arg2!=undefined){flag=1;}
  return flag;
}

function setSearchKind(arg1,arg2){
  var ret=-1;
  if(arg1==undefined && arg2==undefined){ ret=1; }
  else {
    if(arg1=="first" && arg2==undefined){ ret=2; }
    if(arg1=="last" && arg2==undefined){ ret=3;}
    if(arg1.match(/^[0-9]{1,3}$/) && arg2==undefined){ ret=4; }
    if(arg1.match(/^[0-2][0-9][0-5][0-9]$/) && arg2==undefined){ ret=5; }
    if(arg1.match(/^[0-2][0-9][0-5][0-9]$/) && arg2=="-g"){ ret=6; }
  }

  return ret;
}

function getStationInfo(station_from,station_to){
  var station = "eki1=" + station_from + "&eki2=" + station_to + "&";
  return station;
}

function getSearchURL(arg1,arg2,arg3,arg4,search_kind){
  var url="";
  if(search_kind == 1) { url=getURLDepartureNow(arg1,arg2,arg3,arg4); }
  if(search_kind == 2) { url=getURLFirstTrain(arg1,arg2,arg3,arg4); }
  if(search_kind == 3) { url=getURLLastTrain(arg1,arg2,arg3,arg4); }
  if(search_kind == 4) { url=getURLDepartureAfterMinutes(arg1,arg2,arg3,arg4); }
  if(search_kind == 5) { url=getURLDepartureAfterTime(arg1,arg2,arg3,arg4); }
  if(search_kind == 6) { url=getURLArrivalAfterTime(arg1,arg2,arg3,arg4); }
  return url;
}
  
function getURLDepartureNow(arg1,arg2,arg3,arg4){
  var station = getStationInfo(arg1,arg2);
  var search_date = setDate();
  var search_time = "";
  var search_way= "Cway=0&";
  var url = url_origin + station + search_date + search_time + search_way + search_other_query;
  return url;
}

function getURLFirstTrain(arg1,arg2,arg3,arg4){
  var station = getStationInfo(arg1,arg2);
  var search_date = setDate();
  var search_time = "";
  var search_way = "Cway=2&";
  var url = url_origin + station + search_date + search_time + search_way + search_other_query;
  return url;  
}

function getURLLastTrain(arg1,arg2,arg3,arg4){
  var station = getStationInfo(arg1,arg2);
  var search_date = setDate();
  var search_time = "";
  var search_way = "Cway=3&";
  var url = url_origin + station + search_date + search_time + search_way + search_other_query;
  return url;
}

function getURLDepartureAfterMinutes(arg1,arg2,arg3,arg4){
  var station = getStationInfo(arg1,arg2);
  var search_date = setDate();
  var search_time = setTime(parseInt(arg3));
  var search_way = "Cway=0&";
  var url = url_origin + station + search_date + search_time + search_way + search_other_query;
  return url;
}

function getURLDepartureAfterTime(arg1,arg2,arg3,arg4){
  var station = getStationInfo(arg1,arg2);
  var search_date = setDate();
  var search_time = setTimeManually(arg3);
  var search_way = "Cway=0&";
  var url = url_origin + station + search_date + search_time + search_way + search_other_query;
  return url;
}

function getURLArrivalAfterTime(arg1,arg2,arg3,arg4){
  var station = getStationInfo(arg1,arg2);
  var search_date = setDate();
  var search_time = setTimeManually(arg3);
  var search_way = "Cway=1&";
  var url = url_origin + station + search_date + search_time + search_way + search_other_query;
  return url;
}

  
  
function setDate(){
  var date = new Date();
  var year = date.getFullYear(); 
  var month = date.getMonth()+1;
  var search_month = "Dym=" + year + "" + month + "&";
  var search_day = "Ddd=" + date.getDate() + "&";
  var ret= search_month + search_day;
  return ret;
}

function addMinutes(date,number){
  var ret=new Date();
  var baseSec=date.getTime();
  var addSec=number*60*1000;
  var targetSec=baseSec+addSec;
  ret.setTime(targetSec);
  return ret;
}

function setTime(number){
  var nowdate = new Date();
  var date = new Date();
  date = addMinutes(nowdate,number);
  var hour = date.getHours();
  var minute = date.getMinutes();
  minute = ""+minute;
  var min_1 = minute.slice(0,1);
  var min_2 = minute.slice(1);
  var ret = "Dhh=" + hour + "&Dmn1=" + min_1 + "&Dmn2=" + min_2 + "&";  
  return ret;
}

function setTimeManually(manual_time){
  var hour = manual_time.slice(0,2);
  var min_1 = manual_time.slice(2,3);
  var min_2 = manual_time.slice(3);
  var ret = "Dhh=" + hour + "&Dmn1=" + min_1 + "&Dmn2=" + min_2 + "&";
  return ret;
}

function navigate(url){
  if(url!=""){
    chrome.tabs.getSelected(null,function(tab){
      chrome.tabs.update(
        tab.id,
        {url:url}
      );
    });
  }
}

init=function(){
  var buffer = localStorage["BufferMinutes"];
  if(buffer!=null && buffer.match(/^[0-9]+$/)){
    buffer_Minutes=buffer;
  }
};

</script>
</head>
<body>
</body>
</html>
